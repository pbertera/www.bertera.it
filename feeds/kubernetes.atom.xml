<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Pietro Bertera's Blog - Kubernetes</title><link href="http://www.bertera.it/" rel="alternate"></link><link href="http://www.bertera.it/feeds/kubernetes.atom.xml" rel="self"></link><id>http://www.bertera.it/</id><updated>2020-09-24T20:25:00+02:00</updated><subtitle>Something about ...</subtitle><entry><title>Kubernetes semaphore Validating Webhook</title><link href="http://www.bertera.it/kubernetes-semaphore-validating-webhook.html" rel="alternate"></link><published>2020-09-24T20:25:00+02:00</published><updated>2020-09-24T20:25:00+02:00</updated><author><name>Pietro</name></author><id>tag:www.bertera.it,2020-09-24:/kubernetes-semaphore-validating-webhook.html</id><summary type="html">&lt;p&gt;After more than 2 years a new post!&lt;/p&gt;
&lt;p&gt;In the path of learning Kubernetes &lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/"&gt;Dynamic Admission Control&lt;/a&gt; I wrote a small webhook to be used as a semaphore to deny certains operations on k8s objects with a specific label.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/pbertera/k8s-semaphore"&gt;k8s-semaphore&lt;/a&gt; is a quick and dirty &lt;a href="https://webpy.org/"&gt;web.py&lt;/a&gt; app implementing the â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;After more than 2 years a new post!&lt;/p&gt;
&lt;p&gt;In the path of learning Kubernetes &lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/"&gt;Dynamic Admission Control&lt;/a&gt; I wrote a small webhook to be used as a semaphore to deny certains operations on k8s objects with a specific label.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/pbertera/k8s-semaphore"&gt;k8s-semaphore&lt;/a&gt; is a quick and dirty &lt;a href="https://webpy.org/"&gt;web.py&lt;/a&gt; app implementing the webhook, can be deployed on any Kubernetes cluster.&lt;/p&gt;
&lt;p&gt;Here is a self-explaining usage of the admission controller:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$&lt;span class="w"&gt; &lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;lt;&amp;lt; EOF | oc apply -f -&lt;/span&gt;
&lt;span class="s"&gt;apiVersion: v1&lt;/span&gt;
&lt;span class="s"&gt;kind: Pod&lt;/span&gt;
&lt;span class="s"&gt;metadata:&lt;/span&gt;
&lt;span class="s"&gt;  annotations:&lt;/span&gt;
&lt;span class="s"&gt;    bertera.it/k8s-semaphore: red&lt;/span&gt;
&lt;span class="s"&gt;  name: k8s-semaphore-test&lt;/span&gt;
&lt;span class="s"&gt;spec:&lt;/span&gt;
&lt;span class="s"&gt;  containers:&lt;/span&gt;
&lt;span class="s"&gt;  - name: test&lt;/span&gt;
&lt;span class="s"&gt;    image: alpine&lt;/span&gt;
&lt;span class="s"&gt;    # Just spin &amp;amp; wait forever&lt;/span&gt;
&lt;span class="s"&gt;    command: [ &amp;quot;/bin/bash&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;--&amp;quot; ]&lt;/span&gt;
&lt;span class="s"&gt;    args: [ &amp;quot;while true; do sleep 30; done;&amp;quot; ]&lt;/span&gt;
&lt;span class="s"&gt;EOF&lt;/span&gt;

$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;pod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;
NAME&lt;span class="w"&gt;     &lt;/span&gt;READY&lt;span class="w"&gt;   &lt;/span&gt;STATUS&lt;span class="w"&gt;    &lt;/span&gt;RESTARTS&lt;span class="w"&gt;   &lt;/span&gt;AGE
&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt;     &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1&lt;span class="w"&gt;     &lt;/span&gt;Running&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;29m

$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;delete&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;
Error&lt;span class="w"&gt; &lt;/span&gt;from&lt;span class="w"&gt; &lt;/span&gt;server:&lt;span class="w"&gt; &lt;/span&gt;admission&lt;span class="w"&gt; &lt;/span&gt;webhook&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;k8s-semaphore.k8s-semaphore.svc&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;denied&lt;span class="w"&gt; &lt;/span&gt;the&lt;span class="w"&gt; &lt;/span&gt;request:&lt;span class="w"&gt; &lt;/span&gt;Resource&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;kind:&lt;span class="w"&gt; &lt;/span&gt;Pod,&lt;span class="w"&gt; &lt;/span&gt;version:&lt;span class="w"&gt; &lt;/span&gt;v1,&lt;span class="w"&gt; &lt;/span&gt;group:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;is&lt;span class="w"&gt; &lt;/span&gt;annotated&lt;span class="w"&gt; &lt;/span&gt;with&lt;span class="w"&gt; &lt;/span&gt;bertera.it/k8s-semaphore,&lt;span class="w"&gt; &lt;/span&gt;cannot&lt;span class="w"&gt; &lt;/span&gt;be&lt;span class="w"&gt; &lt;/span&gt;removed

$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;annotate&lt;span class="w"&gt; &lt;/span&gt;pod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;bertera.it/k8s-semaphore-
pod/test&lt;span class="w"&gt; &lt;/span&gt;annotated

$&lt;span class="w"&gt; &lt;/span&gt;oc&lt;span class="w"&gt; &lt;/span&gt;delete&lt;span class="w"&gt; &lt;/span&gt;pod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;
pod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;test&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;deleted
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The label name and value can be modified via the environemt variables &lt;code&gt;SEMAPHORE_ANNOTATION&lt;/code&gt; and &lt;code&gt;SEMAPHORE_RED&lt;/code&gt;. Depending on the definition of the &lt;code&gt;ValidatingWebhookConfiguration&lt;/code&gt; the admission controller can be applied to any Kubernetes resource and verbs.&lt;/p&gt;
&lt;p&gt;Look at the &lt;a href="https://github.com/pbertera/k8s-semaphore/blob/master/manifest.yaml"&gt;manifest.yaml&lt;/a&gt; for an example deployment and &lt;code&gt;ValidatingWebhookConfiguration&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Hint: &lt;a href="https://github.com/pbertera/ocp-webhook-cert-manager"&gt;OpenShift Webhook Certificate Manager&lt;/a&gt; can help deploying the Webhook certificate on OpenShift.&lt;/p&gt;</content><category term="Kubernetes"></category><category term="Kubernetes"></category><category term="OpenShift"></category></entry></feed>