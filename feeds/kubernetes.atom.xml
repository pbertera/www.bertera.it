<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Pietro Bertera's Blog</title><link href="https://www.bertera.it/" rel="alternate"></link><link href="https://www.bertera.it/feeds/kubernetes.atom.xml" rel="self"></link><id>https://www.bertera.it/</id><updated>2020-09-24T20:25:00+02:00</updated><entry><title>Kubernetes semaphore Validating Webhook</title><link href="https://www.bertera.it/kubernetes-semaphore-validating-webhook.html" rel="alternate"></link><published>2020-09-24T20:25:00+02:00</published><updated>2020-09-24T20:25:00+02:00</updated><author><name>Pietro</name></author><id>tag:www.bertera.it,2020-09-24:kubernetes-semaphore-validating-webhook.html</id><summary type="html">&lt;p&gt;After more than 3 years a new post!&lt;/p&gt;
&lt;p&gt;In the path of learning Kubernetes &lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/"&gt;Dynamic Admission Control&lt;/a&gt; I wrote a small webhook to be used as a semaphore to deny certains operations on k8s objects with a specific label.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/pbertera/k8s-semaphore"&gt;k8s-semaphore&lt;/a&gt; is a quick and dirty &lt;a href="https://webpy.org/"&gt;web.py&lt;/a&gt; app implementing the webhook, can be deployed on any Kubernetes cluster.&lt;/p&gt;
&lt;p&gt;Here is a self-explaining usage of the admission controller:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat &lt;span class="s"&gt;&amp;lt;&amp;lt; EOF | oc apply -f -&lt;/span&gt;
&lt;span class="s"&gt;apiVersion: v1&lt;/span&gt;
&lt;span class="s"&gt;kind: Pod&lt;/span&gt;
&lt;span class="s"&gt;metadata:&lt;/span&gt;
&lt;span class="s"&gt;  annotations:&lt;/span&gt;
&lt;span class="s"&gt;    bertera.it/k8s-semaphore: red&lt;/span&gt;
&lt;span class="s"&gt;  name: test&lt;/span&gt;
&lt;span class="s"&gt;spec:&lt;/span&gt;
&lt;span class="s"&gt;  containers:&lt;/span&gt;
&lt;span class="s"&gt;  - name: test&lt;/span&gt;
&lt;span class="s"&gt;    image: alpine&lt;/span&gt;
&lt;span class="s"&gt;    # Just spin &amp;amp; wait forever&lt;/span&gt;
&lt;span class="s"&gt;    command: [ &amp;quot;/bin/bash&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;--&amp;quot; ]&lt;/span&gt;
&lt;span class="s"&gt;    args: [ &amp;quot;while true; do sleep 30; done;&amp;quot; ]&lt;/span&gt;
&lt;span class="s"&gt;EOF&lt;/span&gt;

$ oc get pod &lt;span class="nb"&gt;test&lt;/span&gt;
NAME     READY   STATUS    RESTARTS   AGE
&lt;span class="nb"&gt;test&lt;/span&gt;     &lt;span class="m"&gt;1&lt;/span&gt;/1     Running   &lt;span class="m"&gt;0&lt;/span&gt;          29m

$ oc delete &lt;span class="nb"&gt;test&lt;/span&gt;
Error from server: admission webhook &lt;span class="s2"&gt;&amp;quot;k8s-semaphore.k8s-semaphore.svc&amp;quot;&lt;/span&gt; denied the request: Resource &lt;span class="nb"&gt;test&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;kind: Pod, version: v1, group: &lt;span class="o"&gt;)&lt;/span&gt; is annotated with bertera.it/k8s-semaphore, cannot be removed

$ oc annotate pod &lt;span class="nb"&gt;test&lt;/span&gt; bertera.it/k8s-semaphore-
pod/test annotated

$ oc delete pod &lt;span class="nb"&gt;test&lt;/span&gt;
pod &lt;span class="s2"&gt;&amp;quot;test&amp;quot;&lt;/span&gt; deleted
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The label name and value can be modified via the environemt variables &lt;code&gt;SEMAPHORE_ANNOTATION&lt;/code&gt; and &lt;code&gt;SEMAPHORE_RED&lt;/code&gt;. Depending on the definition of the &lt;code&gt;ValidatingWebhookConfiguration&lt;/code&gt; the admission controller can be applied to any Kubernetes resource and verbs.&lt;/p&gt;
&lt;p&gt;Look at the &lt;a href="https://github.com/pbertera/k8s-semaphore/blob/master/manifest.yaml"&gt;manifest.yaml&lt;/a&gt; for an example deployment and &lt;code&gt;ValidatingWebhookConfiguration&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Hint: &lt;a href="https://github.com/pbertera/ocp-webhook-cert-manager"&gt;OpenShift Webhook Certificate Manager&lt;/a&gt; can help deploying the Webhook certificate on OpenShift.&lt;/p&gt;</summary><category term="Kubernetes"></category><category term="OpenShift"></category></entry></feed>