<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.bertera.it/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.bertera.it/theme/pygments/default.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.bertera.it/theme/font-awesome/css/font-awesome.min.css">


    <link href="http://www.bertera.it/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Pietro Bertera's Blog Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#ff3333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#ff3333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="admin" />
<meta name="description" content="I up against this problem on a server hosted by Hetzner.My server is a virtual hypervisor containing several virtual machines.The Hetzner's politics is to statically associate a public IP to a single mac address, is therefore impossible to have multiple IP address on a single ethernet device ..." />
<meta name="keywords" content="iptables, linux, networking, routing">
<meta property="og:site_name" content="Pietro Bertera's Blog"/>
<meta property="og:title" content="Howto configure multiple mac address over a single ethernet interface"/>
<meta property="og:description" content="I up against this problem on a server hosted by Hetzner.My server is a virtual hypervisor containing several virtual machines.The Hetzner's politics is to statically associate a public IP to a single mac address, is therefore impossible to have multiple IP address on a single ethernet device ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://www.bertera.it/howto-configure-multiple-mac-address-over-a-single-ethernet-interface.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2011-10-04 18:01:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://www.bertera.it/author/admin.html">
<meta property="article:section" content="hack, systems"/>
<meta property="article:tag" content="iptables"/>
<meta property="article:tag" content="linux"/>
<meta property="article:tag" content="networking"/>
<meta property="article:tag" content="routing"/>
<meta property="og:image" content="//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120">
  <title>Pietro Bertera's Blog &ndash; Howto configure multiple mac address over a single ethernet interface</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://www.bertera.it">
        <img src="//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120" alt="Pietro Bertera" title="Pietro Bertera">
      </a>
      <h1><a href="http://www.bertera.it">Pietro Bertera</a></h1>
<p>Something about IT, sports and life</p>      <nav>
        <ul class="list">
          <li><a href="http://www.bertera.it/pages/about.html#about">About</a></li>
          <li><a href="http://www.bertera.it/pages/contact.html#contact">Contact</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/pietrobertera" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/pbertera" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/pbertera" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="//bertera.it/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://www.bertera.it">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://www.bertera.it/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="howto-configure-multiple-mac-address-over-a-single-ethernet-interface">Howto configure multiple mac address over a single ethernet interface</h1>
    <p>Posted on Tue 04 October 2011 in <a href="http://www.bertera.it/category/hack-systems.html">hack, systems</a></p>
  </header>
  <div>
    <p>I up against this problem on a server hosted by Hetzner.My server is a
virtual hypervisor containing several virtual machines.The Hetzner's
politics is to statically associate a public IP to a single mac address,
is therefore impossible to have multiple IP address on a single ethernet
device.  Observing this rule you can associate only one virtual machine
with one public IP, and you cannot create a firewall with all public IPs
attested on public interface and private interfaces attached to a
vSwitchs.</p>
<p>To solve the problem you can use the macvlan module. Macvlan allow to
create indipendent logical devices over a single ethernet device. In
this way you have three (logical) ethernet device with three IPs and
three mac address over a single physical device. This solve the
addressing problem but slightly complicates routing and NAT.</p>
<h3>Configuration example:</h3>
<p><strong>Public IPs:</strong>  </p>
<p>A.A.A.A associated mac address: aa:aa:aa:aa:aa:aa  </p>
<p>B.B.B.B associated mac address: bb:bb:bb:bb:bb:bb  </p>
<p>C.C.C.C associated mac address: cc:cc:cc:cc:cc:cc  </p>
<p>External interface: eth0  </p>
<p><strong>Gateway:</strong><br />
X.X.X.X</p>
<p><strong>Internal Subnets:</strong><br />
a.a.a.0/24 (eth1)<br />
b.b.b.0/24 (eth2)<br />
c.c.c.0/24 (eth3)</p>
<p><strong>Firewall IPs on internal subnets:</strong><br />
eth1: a.a.a.254<br />
eth2: b.b.b.254<br />
eth3: c.c.c.254</p>
<h3>Network schema:</h3>
<p>I want to map the outgoing connections in this way:</p>
<table>
<thead>
<tr>
<th><strong>Origin subnet</strong></th>
<th><strong>Public IP</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>a.a.a.0/24</td>
<td>A.A.A.A</td>
</tr>
<tr>
<td>b.b.b.0/24</td>
<td>B.B.B.B</td>
</tr>
<tr>
<td>c.c.c.0/24</td>
<td>C.C.C.C</td>
</tr>
</tbody>
</table>
<h3>Macvlan interface creation</h3>
<ol>
<li>set-up link on physical device:</li>
</ol>
<div class="highlight"><pre><span></span>    ip link set up dev eth0
</pre></div>


<ol>
<li>create logical interfaces:</li>
</ol>
<div class="highlight"><pre><span></span>    ip link add link eth0 dev peth0 type macvlan address aa:aa:aa:aa:aa:aa
    ip link add link eth0 dev peth1 type macvlan address bb:bb:bb:bb:bb:bb
    ip link add link eth0 dev peth2 type macvlan address cc:cc:cc:cc:cc:cc
</pre></div>


<ol>
<li>Assign ip address and activate link:</li>
</ol>
<div class="highlight"><pre><span></span>    ip addr add A.A.A.A/26 dev peth0
    ip addr add B.B.B.B/26 dev peth1
    ip addr add C.C.C.C/26 dev peth2
    ip link set up dev peth0
    ip link set up dev peth1
    ip link set up dev peth2
</pre></div>


<ol>
<li>Normally configure the internal interfaces (eth1, eth2 eth3):</li>
</ol>
<div class="highlight"><pre><span></span>    ip addr add a.a.a.245/24 dev eth1
    ip addr add b.b.b.245/24 dev eth2
    ip addr add b.b.b.245/24 dev eth3
    ip link set up dev eth1
    ip link set up dev eth2
    ip link set up dev eth3
</pre></div>


<ol>
<li>This is the routing situation:</li>
</ol>
<div class="highlight"><pre><span></span># ip route sh
127.0.0.0/8 dev lo  proto kernel  scope link  src 127.0.0.1
a.a.a.0/24 dev eth1  proto kernel  scope link  src a.a.a.254
a.a.a.0/24 dev eth2  proto kernel  scope link  src b.b.b.254
a.a.a.0/24 dev eth3  proto kernel  scope link  src c.c.c.254
A.A.A.A/26 dev peth0  proto kernel  scope link  src A.A.A.A
B.B.B.B/26 dev peth1  proto kernel  scope link  src B.B.B.B
C.C.C.C/26 dev peth2  proto kernel  scope link  src C.C.C.C
</pre></div>


<ol>
<li>You must create a routing table for all outgoing interface:</li>
</ol>
<div class="highlight"><pre><span></span>    echo &quot;500 ipA&quot; &gt;&gt; /etc/iproute2/rt_tables
    echo &quot;600 ipB&quot; &gt;&gt; /etc/iproute2/rt_tables
    echo &quot;700 ipC&quot; &gt;&gt; /etc/iproute2/rt_tables
</pre></div>


<ol>
<li>Add a "catch all" routing table:</li>
</ol>
<div class="highlight"><pre><span></span>    echo &quot;1000 catch_all&quot; &gt;&gt; /etc/iproute2/rt_tables
</pre></div>


<ol>
<li>Add gateways for tables:</li>
</ol>
<div class="highlight"><pre><span></span>    ip route add default via X.X.X.X dev peth0 table ipA
    ip route add default via X.X.X.X dev peth1 table ipB
    ip route add default via X.X.X.X dev peth1 table ipC
    ip route add default via X.X.X.X dev peth0 table catch_all
</pre></div>


<ol>
<li>Add routing policy for internal subnet. Note that the priority must
be greater than the priority used for the normal and default tables (for
show all rules: ip rule show )</li>
</ol>
<div class="highlight"><pre><span></span>    ip rule add from a.a.a.0/24 lookup ipA pref 60000
    ip rule add from b.b.b.0/24 lookup ipB pref 60001
    ip rule add from c.c.c.0/24 lookup ipC pref 60002
</pre></div>


<ol>
<li>Add routing policy for local IPs:</li>
</ol>
<div class="highlight"><pre><span></span>    ip rule add from A.A.A.254 lookup ipA pref 60010
    ip rule add from B.B.B.254 lookup ipB pref 60011
    ip rule add from C.C.C.254 lookup ipC pref 60012
</pre></div>


<ol>
<li>Add a catch all routing policy (with preference greater than all):</li>
</ol>
<div class="highlight"><pre><span></span>    ip rule add from all lookup catch_all pref 70000
</pre></div>


<ol>
<li>Configure the NAT:</li>
</ol>
<div class="highlight"><pre><span></span>    iptables -t nat -I POSTROUTING -o peth0 -s a.a.a.0/24 -j SNAT --to-source A.A.A.A
    iptables -t nat -I POSTROUTING -o peth1 -s b.b.b.0/24 -j SNAT --to-source B.B.B.B
    iptables -t nat -I POSTROUTING -o peth2 -s c.c.c.0/24 -j SNAT --to-source C.C.C.C
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.bertera.it/tag/iptables.html">iptables</a>
      <a href="http://www.bertera.it/tag/linux.html">linux</a>
      <a href="http://www.bertera.it/tag/networking.html">networking</a>
      <a href="http://www.bertera.it/tag/routing.html">routing</a>
    </p>
  </div>
</article>

    <footer>
<p>
  &copy; Pietro Bertera 2016 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Pietro Bertera's Blog ",
  "url" : "http://www.bertera.it",
  "image": "//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120",
  "description": "Pietro Bertera's Thoughts and Writings"
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Howto configure multiple mac address over a single ethernet interface",
  "headline": "Howto configure multiple mac address over a single ethernet interface",
  "datePublished": "2011-10-04 18:01:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "admin",
    "url": "http://www.bertera.it/author/admin.html"
  },
  "image": "//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120",
  "url": "http://www.bertera.it/howto-configure-multiple-mac-address-over-a-single-ethernet-interface.html",
  "description": "I up against this problem on a server hosted by Hetzner.My server is a virtual hypervisor containing several virtual machines.The Hetzner's politics is to statically associate a public IP to a single mac address, is therefore impossible to have multiple IP address on a single ethernet device ..."
}
</script></body>
</html>