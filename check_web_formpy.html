<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://www.bertera.it/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.bertera.it/theme/pygments/default.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.bertera.it/theme/font-awesome/css/font-awesome.min.css">


    <link href="http://www.bertera.it/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Pietro Bertera's Blog Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#ff3333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#ff3333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="admin" />
<meta name="description" content="Check script di nagios per eseguire il submit di un form e cercare dei valori nella response del server. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ..." />
<meta name="keywords" content="http, nagios, python">
<meta property="og:site_name" content="Pietro Bertera's Blog"/>
<meta property="og:title" content="Check_web_form.py"/>
<meta property="og:description" content="Check script di nagios per eseguire il submit di un form e cercare dei valori nella response del server. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://www.bertera.it/check_web_formpy.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2008-09-24 16:42:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://www.bertera.it/author/admin.html">
<meta property="article:section" content="Systems"/>
<meta property="article:tag" content="http"/>
<meta property="article:tag" content="nagios"/>
<meta property="article:tag" content="python"/>
<meta property="og:image" content="//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120">
  <title>Pietro Bertera's Blog &ndash; Check_web_form.py</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://www.bertera.it">
        <img src="//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120" alt="Pietro Bertera" title="Pietro Bertera">
      </a>
      <h1><a href="http://www.bertera.it">Pietro Bertera</a></h1>
<p>Something about ...</p>      <nav>
        <ul class="list">
          <li><a href="http://www.bertera.it/pages/about.html#about">About</a></li>
          <li><a href="http://www.bertera.it/pages/contact.html#contact">Contact</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/pietrobertera" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/pbertera" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/pbertera" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="//bertera.it/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://www.bertera.it">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://www.bertera.it/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="check_web_formpy">Check_web_form.py</h1>
    <p>Posted on Wed 24 September 2008 in <a href="http://www.bertera.it/category/systems.html">Systems</a></p>
  </header>
  <div>
    <p>Check script di nagios per eseguire il submit di un form e cercare dei
valori nella response del server.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># vi:si:et:sw=4:sts=4:ts=4</span>
<span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="c1"># -*- Mode: Python -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2006 Bertera Pietro</span>

<span class="c1"># This file may be distributed and/or modified under the terms of</span>
<span class="c1"># the GNU General Public License version 2 as published by</span>
<span class="c1"># the Free Software Foundation.</span>
<span class="c1"># This file is distributed without any warranty; without even the implied</span>
<span class="c1"># warranty of merchantability or fitness for a particular purpose.</span>
<span class="c1">#</span>
<span class="c1"># Check web form</span>
<span class="c1"># Permette di effettuare il submit di un form HTML e di cercare dei contenuti nella</span>
<span class="c1"># response del server</span>
<span class="c1">#</span>
<span class="c1"># Features:</span>
<span class="c1">#</span>
<span class="c1"># * Supporto per i Cookie</span>
<span class="c1"># * URL personabilizzabile per ricevere i cookie</span>
<span class="c1"># * Invio di Header HTTP arbitrari</span>
<span class="c1"># * Ricerca nel contenuto e nell&#39;header della response</span>
<span class="c1">#</span>
<span class="c1"># Esempio:</span>
<span class="c1">#</span>
<span class="c1"># ./check_web_form -a http://www.spam.com/login.php -i username=CiccioUser -i password=CiccioUser -C &quot;^Logged in as:  CiccioUser&quot;</span>
<span class="c1"># Esegue il submit di un form con action=&quot;http://www.spam.com/login.php&quot; e passa i campi username=CiccioUser e password=CiccioUser</span>
<span class="c1"># e controlla che nel risultato ci sia una riga che inizia con &quot;Logged in as:  CiccioUser&quot;</span>
<span class="c1">#</span>
<span class="c1"># ./check_web_form -a http://www.spam.com/login.php -i username=user -i password=Passw -H content-type=application/x-www-form-urlencoded -H &quot;User-Agent=Mozilla&quot; -m POST -c -u http://www.spam.com/smolla_il_cookie -R location=http://www.spam.com/*authenticated</span>
<span class="c1">#</span>
<span class="c1"># * Prende il cookie all&#39; URL http://www.spam.com/smolla_il_cookie (-u)</span>
<span class="c1"># * Tramite metodo POST invia gli header content-type=application/x-www-form-urlencoded e User-Agent=Mozilla (-H)</span>
<span class="c1"># * Invia i valori username e password (-i)</span>
<span class="c1"># * L&#39;invio viene effettuato all&#39;URL http://www.spam.com/login.php (-a)</span>
<span class="c1"># * La ricerca del risultato avviene negl&#39;header location della risposta (-R)</span>

<span class="c1"># Se l&#39;esito ha buon fine ritorna 0 e stampa OK ...</span>
<span class="c1"># Se fallisce ritorna 2 e stampa ERROR ...</span>

<span class="kn">import</span> <span class="nn">optparse</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">httplib2</span> <span class="kn">import</span> <span class="n">Http</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlencode</span>

<span class="k">class</span> <span class="nc">FormSubmitterOptionParser</span> <span class="p">(</span><span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">check_required</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> option not supplied&quot;</span> <span class="o">%</span> <span class="n">option</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;--method&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;HTTP method not implemented use GET or POST&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;--input&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">dest</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;s*=s*&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> must be in format &quot;</span><span class="n">name</span><span class="o">=</span><span class="n">value</span><span class="s2">&quot;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">FormSubmitterOptionParser</span><span class="p">(</span><span class="s2">&quot;usage: %prog [options]&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--method&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;HTTP method (GET or POST), default </span><span class="si">%d</span><span class="s2">efault&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;input fileld name=value&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--action&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action of form&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--cookie&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Support for cookie&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--cookie-url&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;URL used to retrieve cookie&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-H&#39;</span><span class="p">,</span> <span class="s1">&#39;--header&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Send header hdeadername=HeaderValue&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span> <span class="s1">&#39;--content-match&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Check for regular expression match in content&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;--response-match&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Check for regular expression match in response ex: Status=^4??&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Debug mode&quot;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">options</span><span class="p">,</span><span class="n">args</span><span class="p">)</span><span class="o">=</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check required options</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">check_required</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">)</span>
        <span class="c1"># parser.check_required(&#39;-i&#39;)</span>
        <span class="c1"># check http method</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">check_method</span><span class="p">()</span>
        <span class="c1"># check values</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
           <span class="n">parser</span><span class="o">.</span><span class="n">check_input</span><span class="p">()</span>

    <span class="k">except</span>  <span class="ne">AttributeError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>

    <span class="c1"># make header dict</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">header</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;s*=s*&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;s*=s*&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="c1"># make data dict</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;s*=s*&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;s*=s*&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="n">http</span> <span class="o">=</span> <span class="n">Http</span><span class="p">()</span>
    <span class="c1">#headers = None</span>

    <span class="c1"># check in response Header</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">response_match</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">response_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;s*=s*&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">response_match</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">response_value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;s*=s*&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">response_match</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get page to read cookie</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cookie</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Sending request to retrieve cookie:&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;URL: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">action</span>
            <span class="nb">print</span> <span class="s2">&quot;Method: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">method</span>
            <span class="nb">print</span> <span class="s2">&quot;Headers: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">headers</span>
            <span class="nb">print</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cookie_url</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">cookie_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">action</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span> <span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;Response: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">resp</span>
            <span class="nb">print</span> <span class="s2">&quot;Content: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">content</span>
            <span class="nb">print</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">):</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">]})</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlsplit</span>
            <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlunsplit</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>

            <span class="c1"># if exist query string</span>
            <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">query_string</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">+</span><span class="n">urlencode</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query_string</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">urlunsplit</span><span class="p">((</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">url</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">url</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">url</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
            <span class="n">body</span><span class="o">=</span><span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">action</span>
            <span class="n">body</span><span class="o">=</span><span class="n">urlencode</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Sending request:&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;URL: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">action</span>
            <span class="nb">print</span> <span class="s2">&quot;Method: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">method</span>
            <span class="nb">print</span> <span class="s2">&quot;Headers: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">headers</span>
            <span class="nb">print</span> <span class="s2">&quot;Body: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">body</span>
            <span class="nb">print</span> <span class="s2">&quot;&quot;</span>

        <span class="n">resp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">action</span> <span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;CRITICAL : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;Response: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">resp</span>
        <span class="nb">print</span> <span class="s2">&quot;Content: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">content</span>
        <span class="nb">print</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">content_match</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">content_match</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Error: regexp not valid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;OK Found: &quot;</span>  <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">response_match</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">response_name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">response_value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Error: regexp not valid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">response_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;OK Found: &quot;</span>  <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;CRITICAL: response header </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">response_name</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;CRITICAL : Not found&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>Download: <a href="https://github.com/pbertera/junk/blob/master/nagios-stuff/check_web_form.py">check_web_form.py</a></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.bertera.it/tag/http.html">http</a>
      <a href="http://www.bertera.it/tag/nagios.html">nagios</a>
      <a href="http://www.bertera.it/tag/python.html">python</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'bertera-it';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; Pietro Bertera 2016 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Pietro Bertera's Blog ",
  "url" : "http://www.bertera.it",
  "image": "//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120",
  "description": "Pietro Bertera's Thoughts and Writings"
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Check_web_form.py",
  "headline": "Check_web_form.py",
  "datePublished": "2008-09-24 16:42:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "admin",
    "url": "http://www.bertera.it/author/admin.html"
  },
  "image": "//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120",
  "url": "http://www.bertera.it/check_web_formpy.html",
  "description": "Check script di nagios per eseguire il submit di un form e cercare dei valori nella response del server. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ..."
}
</script></body>
</html>