<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="https://www.bertera.it/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.bertera.it/theme/pygments/default.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.bertera.it/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://www.bertera.it/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Pietro Bertera's Blog Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#ff3333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#ff3333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="admin" />
<meta name="description" content="Update: for an english version of this post you can read the README of pmvcb at github For bacula integration of pvmcb you can see the instruction on bacula wiki VMware offre un pacchetto di backup per le macchine virtuali: VCB Il VCB non fa altro che: eseguire uno snapshot ..." />
<meta name="keywords" content="backup, bacula, script, vmware">
<meta property="og:site_name" content="Pietro Bertera's Blog"/>
<meta property="og:title" content="Poor man vmware consolidate backup"/>
<meta property="og:description" content="Update: for an english version of this post you can read the README of pmvcb at github For bacula integration of pvmcb you can see the instruction on bacula wiki VMware offre un pacchetto di backup per le macchine virtuali: VCB Il VCB non fa altro che: eseguire uno snapshot ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.bertera.it/poor-man-vmware-consolidate-backup.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2011-07-25 21:59:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.bertera.it/author/admin.html">
<meta property="article:section" content="Systems"/>
<meta property="article:tag" content="backup"/>
<meta property="article:tag" content="bacula"/>
<meta property="article:tag" content="script"/>
<meta property="article:tag" content="vmware"/>
<meta property="og:image" content="//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120">
  <title>Pietro Bertera's Blog &ndash; Poor man vmware consolidate backup</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://www.bertera.it">
        <img src="//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120" alt="Pietro Bertera" title="Pietro Bertera">
      </a>
      <h1><a href="https://www.bertera.it">Pietro Bertera</a></h1>
<p>Something about ...</p>      <nav>
        <ul class="list">
          <li><a href="https://www.bertera.it/pages/about.html#about">About</a></li>
          <li><a href="https://www.bertera.it/pages/contact.html#contact">Contact</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/pietrobertera" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/pbertera" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/pbertera" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="//bertera.it/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://www.bertera.it">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="https://www.bertera.it/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="poor-man-vmware-consolidate-backup">Poor man vmware consolidate backup</h1>
    <p>Posted on Mon 25 July 2011 in <a href="https://www.bertera.it/category/systems.html">Systems</a></p>
  </header>
  <div>
    <ul>
<li><strong>Update:</strong> for an english version of this post you
can read the README of pmvcb at <a href="https://github.com/pbertera/pmvcb">github</a><br />
For bacula integration of pvmcb you can see the instruction on bacula <a href="http://wiki.bacula.org/doku.php?id=application_specific_backups:poor_man_vmware_consolidated_backup">wiki</a></li>
</ul>
<p>VMware offre un pacchetto di backup per le macchine virtuali: <a href="http://www.vmware.com/products/vi/cb_overview.html">VCB</a></p>
<p><img alt="VCB" src="https://www.bertera.it/vcb.gif" /></p>
<p>Il VCB non fa altro che:</p>
<ul>
<li>eseguire uno snapshot di una VM</li>
<li>clonare i dischi virtuali della VM</li>
<li>consolidare lo snapshot (rimozione dello snapshot)</li>
</ul>
<p>I vantaggi di un backup del genere sono:</p>
<ul>
<li>si ha il backup una macchina virtuale intera</li>
<li>non ci sono downtime: lo snapshot si puo' fare a caldo</li>
<li>se i vmware tools fanno il loro dovere il filesystem dovrebbe essere
    consistente</li>
</ul>
<p>Gli svantaggi sono:</p>
<ul>
<li>si ha il backup di una macchina virtuale intera (leggi: no
    incrementali)</li>
<li>si hanno gli stessi limiti derivati dall'uso degli snapshot: no RDM,
    ecc..</li>
</ul>
<p>In buona sostanza il VCB è un buon sistema per il disaster recovery (se
i paletti imposti dall'uso degli snapshot non sono troppo restrittivi).</p>
<p>E' possibile implementare un sistema di backup molto simile
automatizzando le operazioni di snapshot, cloning e consolidation
tramite uno script.</p>
<p>Lo script in questione è pmvcb: <a href="/software/pmvcb/">pmvcb</a> esegue le
operazioni sopra elencate su un host ESXi.</p>
<p>Di seguito l'help:</p>
<div class="highlight"><pre><span></span>Usage: ./pmvcb -v [VM] -d [DIR] -h [host] &lt;options&gt;

options:
    -v &lt;vm&gt;       Virtual machine to backup [*]
    -d &lt;dir&gt;  Remote directory to store backup [*]
    -h &lt;host&gt; ESXi host [*]
    -u &lt;user&gt; ESXi username (default: root)
    -f &lt;opts&gt; vmkfstool optons (default: &quot;-a lsilogic -d zeroedthick&quot;)
    -o      overwrite existent backups
    -q      use quiesce snapshot
    -s &lt;opts&gt; ssh options (default: &quot;-i /var/lib/bacula/.ssh/id_rsa&quot;)
    -L &lt;cmd&gt;  local command executed after backup of virtual disks, this command is executed on local machine
    -R &lt;cmd&gt;  remote command executed on ESXi host after local command execution

[*] required options
</pre></div>


<p>come opzioni obbligatorie richiede il nome della VM da 
(<strong>-v</strong>), la directory di appoggio in cui clonare i dischi (<strong>-d</strong>) e
l'host ESXi a cui collegarsi (<strong>-h</strong>).<br />
Tramite l'opzione <strong>-f</strong> è possibile specificare diverse opzioni al
comando vmkfstool utilizato per le operazioni di cloning, tramite <strong>-q</strong>
richiede un'operazione di Quiescing prima di effettuare lo snapshot.<br />
<strong>-s</strong> istruisce il comando ssh (es. ad usare l'autenticazione con
chiave RSA).<br />
<strong>-L</strong> e <strong>-R</strong> eseguono comandi rispettivamente e nell'ordine
sull'host locale e sull'host remoto.</p>
<p>pmvcb si occupa di:</p>
<ul>
<li>verificare che la virtual machine non abbia dischi <em>indipendent</em>
    oppure <em>RDM</em>.</li>
<li>verificare che non ci siano snapshot attivi sulla virtual machine</li>
<li>eseguire lo snapshot</li>
<li>clonare i dischi e il .vmx della virtual machine nella directory
    specificata dall'opzione <strong>-d</strong></li>
<li>consolidare lo snapshot creato</li>
<li>eseguire i comandi specificati da <strong>-L</strong> localmente</li>
<li>eseguire i comandi specificati da <strong>-R</strong> sull'host ESXi remoto</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.bertera.it/tag/backup.html">backup</a>
      <a href="https://www.bertera.it/tag/bacula.html">bacula</a>
      <a href="https://www.bertera.it/tag/script.html">script</a>
      <a href="https://www.bertera.it/tag/vmware.html">vmware</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'bertera-it';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; Pietro Bertera 2016 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Pietro Bertera's Blog ",
  "url" : "https://www.bertera.it",
  "image": "//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120",
  "description": "Pietro Bertera's Thoughts and Writings"
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Poor man vmware consolidate backup",
  "headline": "Poor man vmware consolidate backup",
  "datePublished": "2011-07-25 21:59:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "admin",
    "url": "https://www.bertera.it/author/admin.html"
  },
  "image": "//s.gravatar.com/avatar/f64fc3d41c2a8368feff0b7672ca7571?s=120",
  "url": "https://www.bertera.it/poor-man-vmware-consolidate-backup.html",
  "description": "Update: for an english version of this post you can read the README of pmvcb at github For bacula integration of pvmcb you can see the instruction on bacula wiki VMware offre un pacchetto di backup per le macchine virtuali: VCB Il VCB non fa altro che: eseguire uno snapshot ..."
}
</script></body>
</html>